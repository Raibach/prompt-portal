# Deployment Runbook

## Overview

This runbook provides step-by-step procedures for deploying Grace Editor to Railway and troubleshooting common issues.

---

## Pre-Deployment Checklist

### 1. Local Environment Setup

- [ ] PostgreSQL 15+ installed and running locally
- [ ] Local database `railway` created and initialized
- [ ] All migrations applied
- [ ] Local tests passing: `python3 scripts/database/test_robust_connection.py`
- [ ] API tests passing: `python3 scripts/api/test_conversations_api.py`

### 2. Railway Configuration

- [ ] Railway account active
- [ ] Railway CLI installed: `brew install railway`
- [ ] Logged in: `railway login`
- [ ] Project linked: `railway link`
- [ ] Environment variables set in Railway dashboard:
  - `DATABASE_URL` (internal, auto-generated by Railway)
  - `DATABASE_PUBLIC_URL` (external, for local testing - optional)
  - `NGROK_URL` (if using local model tunnel)
  - Other required variables

### 3. Database Verification

- [ ] Production database schema verified: `python3 scripts/deployment/verify_production_schema.py`
- [ ] Connection pool tested with Railway database
- [ ] All tables exist and match local schema

---

## Deployment Procedure

### Automated Deployment

```bash
# Run automated deployment script
./scripts/deployment/deploy_to_railway.sh
```

The script will:
1. Check Railway CLI installation
2. Verify login status
3. Check environment variables
4. Test database connection
5. Run local tests
6. Deploy to Railway
7. Verify deployment

### Manual Deployment

```bash
# 1. Login to Railway
railway login

# 2. Link project (if not already linked)
railway link

# 3. Deploy
railway up

# 4. Monitor deployment
railway logs --follow
```

---

## Post-Deployment Verification

### 1. Health Checks

```bash
# Test health endpoint
curl https://grace-editor-production.up.railway.app/api/health

# Test database health endpoint
curl https://grace-editor-production.up.railway.app/api/database/health
```

### 2. Automated Verification

```bash
# Run post-deployment verification script
python3 scripts/deployment/verify_deployment.py
```

### 3. Manual Testing

- [ ] Access production URL
- [ ] Test user authentication
- [ ] Create a test conversation
- [ ] Verify database connections working
- [ ] Check logs for errors: `railway logs`

---

## Troubleshooting

### Database Connection Issues

**Problem:** Database connection failures

**Symptoms:**
- `/api/database/health` returns 503
- Error logs show connection timeouts
- API endpoints return database errors

**Solutions:**

1. **Check DATABASE_URL in Railway:**
   ```bash
   railway variables | grep DATABASE_URL
   ```

2. **Verify database service is running:**
   - Go to Railway dashboard â†’ PostgreSQL service
   - Check service status

3. **Test connection from local machine:**
   ```bash
   # Get DATABASE_PUBLIC_URL from Railway dashboard
   export DATABASE_URL="postgresql://user:pass@host:port/db"
   python3 scripts/database/test_robust_connection.py
   ```

4. **Check connection pool stats:**
   ```bash
   curl https://grace-editor-production.up.railway.app/api/database/health
   ```

5. **Review connection pool configuration:**
   - Check `backend/database_pool.py` settings
   - Verify min/max connections appropriate for Railway plan
   - Check health check interval

### SSL Mode Issues

**Problem:** SSL connection errors

**Symptoms:**
- `server does not support SSL, but SSL was required`
- Connection refused errors

**Solutions:**

1. **For local connections:** Use `sslmode=disable` in DATABASE_URL
2. **For Railway internal:** Use `sslmode=prefer` (auto-detected)
3. **For Railway public:** Use `sslmode=require` (auto-detected)

The connection pool manager auto-detects SSL mode based on hostname.

### Schema Mismatch

**Problem:** Production schema doesn't match local

**Symptoms:**
- Migration errors
- Missing tables
- Column errors

**Solutions:**

1. **Compare schemas:**
   ```bash
   python3 scripts/deployment/verify_production_schema.py "DATABASE_URL"
   ```

2. **Apply missing migrations:**
   ```bash
   # Connect to production database
   python3 scripts/database/apply_all_migrations.py
   ```

3. **Verify all tables exist:**
   ```sql
   SELECT table_name FROM information_schema.tables 
   WHERE table_schema = 'public' 
   ORDER BY table_name;
   ```

### Connection Pool Exhaustion

**Problem:** Too many connections

**Symptoms:**
- `connection pool exhausted` errors
- Slow API responses
- Database connection timeouts

**Solutions:**

1. **Check pool statistics:**
   ```bash
   curl https://grace-editor-production.up.railway.app/api/database/health
   ```

2. **Review pool configuration:**
   - Current: min 2, max 10 connections
   - Adjust in `backend/database_pool.py` if needed

3. **Check for connection leaks:**
   - Ensure all connections are properly closed
   - Use context managers: `with pool_manager.get_connection() as conn:`

4. **Monitor active connections:**
   ```sql
   SELECT count(*) FROM pg_stat_activity WHERE datname = 'railway';
   ```

### Health Check Failures

**Problem:** Health checks failing

**Symptoms:**
- `/api/database/health` returns unhealthy
- Pool statistics show errors

**Solutions:**

1. **Check last error in pool stats:**
   ```bash
   curl https://grace-editor-production.up.railway.app/api/database/health | jq .pool_stats.last_error
   ```

2. **Review connection pool logs:**
   - Check Railway logs for connection errors
   - Look for timeout or authentication errors

3. **Test connection manually:**
   ```bash
   python3 scripts/database/test_robust_connection.py
   ```

4. **Reset connection pool:**
   - Restart Railway service
   - Pool will reinitialize on next request

---

## Monitoring

### Key Metrics

Monitor these endpoints regularly:

1. **Health:** `/api/health`
2. **Database Health:** `/api/database/health`
3. **Pool Statistics:** Check `pool_stats` in database health response

### Logs

```bash
# View Railway logs
railway logs --follow

# Filter for database errors
railway logs | grep -i "database\|connection\|pool"

# Filter for API errors
railway logs | grep -i "error\|exception\|failed"
```

### Database Monitoring

```sql
-- Check active connections
SELECT count(*) FROM pg_stat_activity WHERE datname = 'railway';

-- Check connection pool usage
SELECT 
    count(*) as total_connections,
    count(*) FILTER (WHERE state = 'active') as active,
    count(*) FILTER (WHERE state = 'idle') as idle
FROM pg_stat_activity 
WHERE datname = 'railway';
```

---

## Rollback Procedure

If deployment fails:

1. **Check deployment status:**
   ```bash
   railway status
   ```

2. **View deployment logs:**
   ```bash
   railway logs --deployment <deployment-id>
   ```

3. **Revert to previous deployment:**
   - Go to Railway dashboard
   - Select previous successful deployment
   - Click "Redeploy"

4. **Or redeploy from git:**
   ```bash
   git checkout <previous-commit>
   railway up
   ```

---

## Emergency Procedures

### Database Connection Lost

1. **Check Railway PostgreSQL service status**
2. **Verify DATABASE_URL is correct**
3. **Test connection from local machine**
4. **Check Railway service limits (connections, memory)**
5. **Restart Railway service if needed**

### API Completely Down

1. **Check Railway service status**
2. **Review recent deployments**
3. **Check environment variables**
4. **Review logs for errors**
5. **Rollback to last known good deployment**

---

## Best Practices

1. **Always test locally first**
2. **Run all tests before deploying**
3. **Monitor health endpoints after deployment**
4. **Keep deployment logs**
5. **Document any manual changes**
6. **Use feature flags for risky changes**
7. **Deploy during low-traffic periods when possible**

---

## Support

For issues:
1. Check this runbook first
2. Review Railway documentation
3. Check application logs
4. Test locally to isolate issues
5. Contact Railway support if infrastructure issue

---

**Last Updated:** 2025-01-16
**Version:** 1.0

