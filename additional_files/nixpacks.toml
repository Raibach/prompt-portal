[phases.setup]
nixPkgs = ["python311", "mupdf", "nodejs_20"]

[phases.install]
cmds = [
    "python3 -m venv /app/.venv",
    "source /app/.venv/bin/activate && pip install --no-cache-dir -r requirements.txt",
    "echo 'ğŸ“¦ Installing frontend dependencies...'",
    "cd frontend && npm ci --prefer-offline || (echo 'âŒ npm install failed!' && exit 1)",
    "echo 'ğŸ”¨ Building frontend (this must run - dist was removed from git)...'",
    "cd frontend && npm run build || (echo 'âŒ Frontend build FAILED!' && exit 1)",
    "echo 'âœ… Frontend build command completed'",
    "echo 'ğŸ“ Verifying build output exists...'",
    "pwd",
    "echo 'Current directory contents:'",
    "ls -la",
    "echo 'Frontend directory contents:'",
    "ls -la frontend/ || (echo 'âŒ frontend directory not found!' && exit 1)",
    "if [ ! -d 'frontend/dist' ]; then echo 'âŒ CRITICAL: frontend/dist directory does not exist!' && echo 'Frontend directory contents:' && ls -la frontend/ && exit 1; fi",
    "if [ ! -f 'frontend/dist/index.html' ]; then echo 'âŒ CRITICAL: frontend/dist/index.html not found!' && exit 1; fi",
    "echo 'âœ… Frontend build verified - dist folder exists with index.html'",
    "echo 'ğŸ“Š Build output summary:'",
    "du -sh frontend/dist",
    "ls -la frontend/dist/ | head -10",
    "echo 'âœ… Build phase completed successfully'"
]

[start]
cmd = "source /app/.venv/bin/activate && gunicorn grace_api:app --bind 0.0.0.0:$PORT --workers 2 --timeout 120"
